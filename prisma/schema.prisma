generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// User & Auth
// ============================================
model User {
  id           String    @id @default(uuid())
  supabaseId   String    @unique // Supabase Auth user.id
  email        String?   @unique
  nickname     String
  profileImage String?
  score        Int       @default(0)
  deletedAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  artistId     String?
  artist       Artist?   @relation(fields: [artistId], references: [id])

  posts        Post[]
  comments     Comment[]
  markets      Market[]
  likes        Like[]
  marketLikes  MarketLike[]
  purchases    Transaction[] @relation("BuyerTransactions")
  sales        Transaction[] @relation("SellerTransactions")
  activities   Activity[]
  chatMessages ChatMessage[]
  chatRooms    ChatRoomMember[]
}

// ============================================
// Artist & Group
// ============================================
model Agency {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())

  groups    ArtistGroup[]
}

model ArtistGroup {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())

  agencyId  String?
  agency    Agency?  @relation(fields: [agencyId], references: [id])

  artists   Artist[]
}

model Artist {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())

  groupId   String?
  group     ArtistGroup? @relation(fields: [groupId], references: [id])

  users      User[]
  photocards Photocard[]
}

// ============================================
// Photocard
// ============================================
model Photocard {
  id          String   @id @default(uuid())
  name        String
  description String?
  imageUrl    String?
  createdAt   DateTime @default(now())

  artistId    String?
  artist      Artist?  @relation(fields: [artistId], references: [id])

  galmangPocas GalmangPoca[]
}

model GalmangPoca {
  id          String   @id @default(uuid())
  quantity    Int      @default(1)
  createdAt   DateTime @default(now())

  photocardId String
  photocard   Photocard @relation(fields: [photocardId], references: [id])
}

// ============================================
// Post & Comment
// ============================================
model Post {
  id        String   @id @default(uuid())
  content   String
  category  String   @default("free") // free, boast, info
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    String
  user      User     @relation(fields: [userId], references: [id])

  images    PostImage[]
  comments  Comment[]
  likes     Like[]

  @@index([category, createdAt(sort: Desc)])
}

model PostImage {
  id        String   @id @default(uuid())
  imageUrl  String
  createdAt DateTime @default(now())

  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model Comment {
  id        String    @id @default(uuid())
  content   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // soft delete for "삭제된 댓글입니다" display

  postId    String
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)

  userId    String
  user      User      @relation(fields: [userId], references: [id])

  // Self-referential for nested comments (대댓글)
  parentId  String?
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")

  @@index([postId, createdAt])
  @@index([parentId])
}

// ============================================
// Market
// ============================================
model Market {
  id          String   @id @default(uuid())
  title       String
  description String?
  price       Int?
  status      String   @default("available") // available, sold, reserved
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId      String
  user        User     @relation(fields: [userId], references: [id])

  images       MarketImage[]
  likes        MarketLike[]
  transactions Transaction[]
}

model MarketImage {
  id        String   @id @default(uuid())
  imageUrl  String
  createdAt DateTime @default(now())

  marketId  String
  market    Market   @relation(fields: [marketId], references: [id], onDelete: Cascade)
}

// ============================================
// Like
// ============================================
model Like {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  userId    String
  user      User     @relation(fields: [userId], references: [id])

  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
}

// ============================================
// Market Like (찜)
// ============================================
model MarketLike {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  userId    String
  user      User     @relation(fields: [userId], references: [id])

  marketId  String
  market    Market   @relation(fields: [marketId], references: [id], onDelete: Cascade)

  @@unique([userId, marketId])
}

// ============================================
// Transaction (거래 내역)
// ============================================
model Transaction {
  id          String   @id @default(uuid())
  type        String   // purchase, sale
  status      String   @default("completed") // pending, completed, cancelled
  price       Int
  completedAt DateTime @default(now())
  createdAt   DateTime @default(now())

  buyerId     String
  buyer       User     @relation("BuyerTransactions", fields: [buyerId], references: [id])

  sellerId    String
  seller      User     @relation("SellerTransactions", fields: [sellerId], references: [id])

  marketId    String
  market      Market   @relation(fields: [marketId], references: [id])
}

// ============================================
// Activity (활동 내역)
// ============================================
model Activity {
  id          String   @id @default(uuid())
  type        String   // post, like, comment, trade, market
  description String
  targetId    String   // post/market/transaction ID
  targetType  String   // post, market, transaction
  createdAt   DateTime @default(now())

  userId      String
  user        User     @relation(fields: [userId], references: [id])
}

// ============================================
// Chat (Supabase Realtime용)
// ============================================
model ChatRoom {
  id        String   @id @default(uuid())
  name      String?
  createdAt DateTime @default(now())

  members   ChatRoomMember[]
  messages  ChatMessage[]
}

model ChatRoomMember {
  id        String   @id @default(uuid())
  joinedAt  DateTime @default(now())

  roomId    String
  room      ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  userId    String
  user      User     @relation(fields: [userId], references: [id])

  @@unique([roomId, userId])
}

model ChatMessage {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())

  roomId    String
  room      ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  userId    String
  user      User     @relation(fields: [userId], references: [id])
}
